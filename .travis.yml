language: go
sudo: required

go:
  - 1.x

install:
  - go get -u github.com/golang/dep/cmd/dep

before_script:
  - cd test
  - dep ensure
  - docker build -t pike-test-server .
  - cd ..

script:
  - dep ensure
  - cd vendor/github.com/google/brotli
  - ./configure-cmake
  - make && sudo make install
  - cd ../../../..
  - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
  - go test -race -cover ./...

after_success:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker build -t pike .
  - docker images
  - docker tag pike $DOCKER_USERNAME/pike
  - docker push $DOCKER_USERNAME/pike
