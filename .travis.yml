language: go
sudo: required

go:
  - 1.10.x

install:
  - go get -u github.com/golang/dep/cmd/dep

script:
  - dep ensure
  - cd vendor/github.com/google/brotli
  - ./configure-cmake
  - make && sudo make install
  - cd ../../../..
  - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
  - go test -race -cover -v ./...

after_success:
  - export VERSION=1.0.0
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker build -t pike .
  - docker tag pike $DOCKER_USERNAME/pike:$VERSION
  - docker push $DOCKER_USERNAME/pike:$VERSION
  - docker images
